<style type="text/css">
.block {
  display:inline-block;
  border:thin solid #CCC;
  padding:.15em;
  text-align:center;
}
.block span {
  display:block;
}
.block div {
  margin:0;
  padding:0;
}
#screen {
  height:128px;
  width:128px;
  border:thin solid #CCC;
  display:block;
  position:relative;
}
#guess, #playback, #reduced, .frame {
  height:16px;
  width:16px;
  border:thin solid #CCC;
  display:block;
}
#guess, #playback, .frame {
  position:relative;
}
.frame {
  padding:0;
  display:inline-block;
}
.point {
  height:1px;
  width:1px;
  background-color:#000;
  position:absolute;
  margin:0;
  padding:0;
}
.left, .right {
  vertical-align:top;
  display:inline-block;
  margin:1em;
}
.frames {
  margin: 1em;
}
#frames, #trained {
  padding: .15em;
  display:block;
  border:thin solid #CCC;
}
table {
  clear:both;
}
</style>
<h1>Trainer</h1>
<ol>
  <li>Click <em>Record</em></li>
  <li>Click and Drag on the <em>Surface</em> to draw</li>
  <li>Click <em>Stop</em></li>
  <li>Click <em>Play</em> to watch the condensed version of your actions</li>
  <li>Click <em>Train</em> to train the brain with your image</li>
  <li>Click <em>Reset</em> to start over</li>
</ol>
<p>As you train new images, the brain will continue to process them and learn. The brain will
also take a guess and tell you what combinations of patterns it thinks you are doing.  The more
data you feed the brain the better it will be.</p>
<div class="left">
  <div class="block">
    <span>Surface</span>
    <div id="screen"></div>
  </div>
  <div class="block">
      <span>Reduced</span>
    <div id="reduced"></div>
  </div>
  <div class="block">
    <span>Playback</span>
    <div id="playback"></div>
  </div>
  <div class="block">
    <span>Guess</span>
    <div id="guess"></div>
  </div>
</div>
<div class="right">
  <div id="controls">
    <button name="clear">Clear</button>
    <button name="record">Record</button>
    <button name="play">Play</button>
    <button name="train">Train</button>
    <button name="stop">Stop</button>
    <button name="reset">Reset</button>
  </div>
  <div id="status"></div>
  <div id="training"></div>
  </div>
<div class="frames">
  <span>Frames</span>
  <div id="frames"></div>
</div>
<div class="frames">
  <span>Trained</span>
  <div id="trained"></div>
</div>
<div id="network">
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="/core.js"></script>
<script>
$(function () {
  var net = new Brain.NeuralNetwork();
  var train = net.createTrainStream({
      floodCallback: function () {
        var i = -1;
        (function next () {
          if (++i > trained.length || !trained[i]) return train.write(null);
          train.write(trained[i]);
          setTimeout(next, 0);
        })();
      },
      doneTrainingCallback: function (info) {
        var buf = []
        for (var k in info) {
          buf[buf.length] = k + ': ' + info[k];
        }
        $('#training').html(buf.join('<br />'));
      },
      log: true,
      callbackPeriod: 100,
      hiddenLayers:[256,256],
      callback: function (info) {
        var buf = []
        for (var k in info) {
          buf[buf.length] = k + ': ' + info[k];
        }
        $('#training').html(buf.join('<br />'));
      }
  });
  var I = 100;
  var W = 128, H = 128;
  var w = 16, h = 16;
  var surface = Frame(W,H);
  var tape = [];
  var trained = [];
  var index = -1;
  var frame = Frame(W,H);
  $('#controls').each(function () {
    var self = $(this);
    self.find('button[name="play"],button[name="stop"],button[name="train"],button[name="reset"]').hide();
    self.find('button[name="record"]').click(function () {
      self.find('button[name="stop"]').show();
      $(this).hide();
    });
    self.find('button[name="clear"]').each(function () {
      $(this).click(function () {
        $('#screen,#reduced,#playback,#guess').html('');
        surface = Frame(W,H);
      });
    });
    self.find('button[name="play"]').click(function () {
      $(this).hide();
      var playback = Frame(w, h);
      (function next () {
        if (++index >= tape.length) return;
        try {
          playback.stack(tape[index]);
          var ui = $('#playback');
      //    ui.empty();
          var buf = '';
          playback.each(function (cell) {
            if (!cell.data) return;
            buf = buf + '<div class="point" style="top:'+cell.y+'px;left:'+cell.x+'px"></div>';
          });
          ui.html(buf);
        }
        catch(e) { console.error(e); };
        setTimeout(next, I);
      })();
    });
    self.find('button[name="train"]').click(function () {
      setTimeout(function () {
      var pattern = Frame(w, h);
      var input = [], output = [];
      for (var i=0; i<tape.length; i++) pattern.stack(tape[i]);
      console.log(pattern.data.join(''));
      var ui = $('<div>').addClass('frame');
      pattern.each(function (cell, i) {
        input[i] = pattern.bound(cell.data);
        output[i] = 0; 
        if (!cell.data) return;
        output[i] = 1; 
        var x = cell.x, y = cell.y;
        ui.append($('<div>').addClass('point').css({top:y, left:x}));
      });
      trained.push({input:input, output:output});
      train.write({input:input, output:output});
      train.write(null);
      $('#trained').append(ui);
      tape.length = 0;
      index = -1;
      $('#frames, #guess, #playback, #reduced').html('');
      },I);
      $(this).hide();
    });
    self.find('button[name="stop"]').click(function () {
      self.find('button[name="record"],button[name="play"],button[name="train"],button[name="reset"]').show();
      $(this).hide();
    });
    self.find('button[name="reset"]').click(function () {
      self.find('button[name="record"]').show();
      self.find('button[name="play"],button[name="train"]').hide();
      $(this).hide();
      tape.length = 0;
      index = -1;
      $('#screen, #frames, #guess, #playback, #reduced').html('');
    });
  });
  $('#screen').each(function () {
    var offset = $(this).offset();
    $(this).resize(function () {
      offset = $(this).offset();
    });
    function plot (e) {
      var x = Math.round(e.pageX - offset.left), y = Math.round(e.pageY - offset.top);
      surface.inc(x,y);
      frame.inc(x,y);
      $(this).append($('<div>').addClass('point').css({top:y, left:x}));
    }
    $(this).mousemove(function (e) {
      var x = Math.round(e.pageX - offset.left), y = Math.round(e.pageY - offset.top);
      $('#status').html('x: '+ x + '<br />y: ' + y + '<br />');
    });
    $(this).mousedown(function () {
      $(this).mousemove(plot);
    });
    $(this).mouseup(function () {
      $(this).unbind('mousemove', plot);
      var guess = Frame(w,h);
      try { guess.data = net.run(surface.scale(w,h).data); } catch (e) { } 
      guess.data = guess.data || [];
      var buf = '';
      guess.each(function (cell) {
        if (!cell.data) return;
        buf = buf + '<div class="point" style="top:'+(cell.y)+'px;left:'+(cell.x)+'px;opacity:'+cell.data+'"></div>';
      });
      $('#guess').html(buf);
    });
  });
  setInterval(function () {
    $('#reduced').html('');
    var self = $('#reduced');
    var offset = self.offset();
    var buf = '';
    var scaled = surface.scale(w,h).each(function (cell) {
      if (!cell.data) return;
//      var x = cell.x + offset.left, y = cell.y + offset.top;
        buf = buf + '<div class="point" style="top:'+(cell.y+offset.top)+'px;left:'+(cell.x+offset.left)+'px"></div>';
 //     self.append($('<div>').addClass('point').css({top:y, left:x}));
    });
    self.html(buf);
  }, I);
  setInterval(function () {
    if ($('button[name="record"]').is(':visible')) return;
    var buf = frame.dump();
    var scaled = buf.scale(w,h);
    tape.push(scaled);
    /*
    train.write({input:scaled.data, output:scaled.data});
    if (tape[tape.length - 1]) train.write({input:tape[tape.length - 1].data, output:scaled.data});
    train.write(null);
    */

    if ($('#frames > .frame').length > 30) {
      $('#frames > .frame').first().remove();
    }
    var ui = $('<div>').addClass('frame');
    scaled.each(function (cell) {
      if (!cell.data) return;
      var x = cell.x, y = cell.y;
      ui.append($('<div>').addClass('point').css({top:y, left:x}));
    });
    $('#frames').append(ui);
  },I);
});
</script>
